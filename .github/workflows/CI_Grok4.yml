name: CI_Grok4

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

permissions:
  contents: write
  pull-requests: write
  checks: write

concurrency:
  group: ci-gemini
  cancel-in-progress: false

env:
  API_URL: "https://openrouter.ai/api/v1/chat/completions"
  AI_MODEL: "x-ai/grok-4-fast:free"
  OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
  GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

jobs:
  ai-deps:
    runs-on: ubuntu-latest
    env:
      BASE_BRANCH: ${{ github.ref_name }}

    steps:
      - name: Checkout repository (full)
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Configure git
        run: |
          git config user.name "ci-gemini-bot"
          git config user.email "ci-gemini-bot@users.noreply.github.com"

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: stable

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}

      - name: Install golangci-lint
        uses: golangci/golangci-lint-action@v8
        with:
          version: v1.64.2

      - name: Ensure scripts are executable
        run: |
          chmod +x .github/scripts/ai_refactor.sh || true
          chmod +x .github/scripts/auto_fix_lints.sh || true

      - name: "Patch ai_refactor.sh to enable OpenRouter reasoning (effort: high)"
        run: |
          # Insert include_reasoning and reasoning fields into the payload built by ai_refactor.sh
          perl -0777 -pe 's/max_tokens:\s*32768\s*\n\s*}/max_tokens: 32768,\n      include_reasoning: true,\n      reasoning: { effort: "high" }\n    }/s' -i .github/scripts/ai_refactor.sh
          # verify patch applied
          grep -n "include_reasoning" .github/scripts/ai_refactor.sh || (echo "Failed to patch ai_refactor.sh" && exit 1)

      - name: Run AI refactor (produce ai.patch and artifacts) â€” do not allow the script to push/create PR itself
        id: run_refactor
        env:
          API_URL: ${{ env.API_URL }}
          AI_MODEL: ${{ env.AI_MODEL }}
          OPENROUTER_API_KEY: ${{ env.OPENROUTER_API_KEY }}
          # prevent the script from pushing or creating PRs itself (we will create a restricted PR later)
          GITHUB_TOKEN: ""
        run: |
          set -euo pipefail
          .github/scripts/ai_refactor.sh dependencies "${API_URL}" "${AI_MODEL}" || true
          # Copy artifacts into workspace if produced by the script
          test -f ai.patch && echo "ai.patch created" || echo "ai.patch not present"
          ls -lah || true

      - name: Apply AI patch locally (if present)
        id: apply_patch
        run: |
          set -euo pipefail
          if [ -f ai.patch ]; then
            if git apply --check ai.patch; then
              git apply ai.patch
              echo "Applied ai.patch to workspace."
            else
              echo "ai.patch present but failed git apply --check; saving for artifact and continuing."
              exit 0
            fi
          else
            echo "No ai.patch to apply."
          fi

      - name: Show workspace changes
        if: always()
        run: |
          echo "Git status:"
          git status --porcelain
          echo "Changed files:"
          git --no-pager diff --name-only || true

      - name: Create Pull Request for Go/module changes only
        if: success()
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GH_TOKEN }}
          commit-message: "chore: automated dependency updates and AI refactor"
          title: "chore(deps): Automated dependency updates and AI refactor"
          body: |
            Automated dependency updates and AI-driven refactor were applied by CI. Please review the changes.
          branch: automated-deps
          branch-suffix: timestamp
          delete-branch: true
          add-paths: |
            **/*.go
            go.mod
            go.sum

      - name: Run golangci-lint and capture output
        run: |
          set -euo pipefail
          if golangci-lint run ./... 2>&1 | tee linter.log; then
            echo "golangci-lint completed without fatal errors."
          else
            echo "golangci-lint reported issues; see linter.log."
          fi

      - name: Run tests and capture output
        run: |
          set -euo pipefail
          go test ./... 2>&1 | tee tests.log || true

      - name: Run gofmt check
        run: |
          set -euo pipefail
          gofmt -l . > gofmt.list || true
          if [ -s gofmt.list ]; then
            echo "Files that need gofmt:"
            cat gofmt.list
          fi

      - name: Run gitleaks scan (non-blocking)
        uses: gitleaks/gitleaks-action@v2
        with:
          args: detect --format json --report-path=gitleaks.json || true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Upload CI artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-gemini-artifacts
          path: |
            ai-request.json
            ai-response.json
            ai-response-raw.txt
            ai.patch
            tests.log
            linter.log
            gitleaks.json
            pre-ai.diff
            push.log
            gofmt.list

      - name: Final status
        if: always()
        run: echo "CI_Gemini workflow finished."
