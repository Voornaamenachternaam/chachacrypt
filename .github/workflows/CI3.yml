name: CI

on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * *"  # Daily at 6:00 UTC

jobs:
  update-go:
    name: Update to Latest Go Version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5.0.0
        with:
          fetch-depth: 0

      - name: Get Latest Go Version
        id: go-version
        run: |
          set -euo pipefail
          echo "Fetching latest Go release..."
          JSON=$(curl -fLsS https://go.dev/dl/?mode=json)
          
          LATEST_VERSION=$(echo "$JSON" | \
            jq -r 'map(select(.stable==true)) | first | .version' | \
            sed 's/^go//')
          
          if [ -z "$LATEST_VERSION" ]; then
            echo "::error::Failed to determine latest Go version"
            exit 1
          fi
          
          echo "version=$LATEST_VERSION" >> "$GITHUB_OUTPUT"
          echo "Using Go version: $LATEST_VERSION"

      - name: Set up Go ${{ steps.go-version.outputs.version }}
        uses: actions/setup-go@v5.5.0
        with:
          go-version: ${{ steps.go-version.outputs.version }}

      - name: Verify go.mod version
        run: |
          set -euo pipefail
          sed -i "s/^go .*/go ${{ steps.go-version.outputs.version }}/" go.mod
          go mod tidy

      - name: Upgrade dependencies
        run: |
          set -euo pipefail
          # Get all direct dependencies
          go list -m -f '{{if not (or .Indirect .Main)}}{{.Path}}{{end}}' all > direct_deps.txt
          
          # Update direct dependencies within same major version
          while read -r dep; do
            if [ -n "$dep" ]; then
              current_version=$(go list -m -f '{{.Version}}' "$dep")
              latest_version=$(go list -m -f '{{.Version}}' "$dep@latest")
              
              # Only update if major version matches
              if [ "${current_version%%.*}" = "${latest_version%%.*}" ]; then
                go get "$dep@latest"
              fi
            fi
          done < direct_deps.txt
          
          go mod tidy

      - name: Run tests
        id: test
        run: |
          set -euo pipefail
          if go test ./... -v 2>&1 | tee test_output.txt; then
            echo "tests_failed=false" >> "$GITHUB_OUTPUT"
          else
            echo "tests_failed=true" >> "$GITHUB_OUTPUT"
            exit 1
          fi

      - name: Install and use git-cliff
        run: |
          set -euo pipefail
          # Download and install git-cliff
          curl -fsSL https://github.com/orhun/git-cliff/releases/download/v2.10.0/git-cliff-2.10.0-x86_64-unknown-linux-gnu.tar.gz -o git-cliff.tar.gz
          tar xzf git-cliff.tar.gz
          
          # For version 2.10.0, the binary is directly in the root of the tar
          # Check if the binary exists in the expected location
          if [ -f "git-cliff" ]; then
            sudo install -m 0755 git-cliff /usr/local/bin/git-cliff
          else
            # Try to find the binary anywhere in the extracted files
            BINARY_PATH=$(find . -name "git-cliff" -type f | head -n 1)
            if [ -n "$BINARY_PATH" ]; then
              sudo install -m 0755 "$BINARY_PATH" /usr/local/bin/git-cliff
            else
              echo "::error::Could not find git-cliff binary in the extracted archive"
              echo "Contents of the extracted archive:"
              find . -type f
              exit 1
            fi
          fi
          
          # Generate changelog
          git-cliff --unreleased --output changelog.md

      - name: Prepare PR body
        run: |
          set -euo pipefail
          GO_VER="${{ steps.go-version.outputs.version }}"
          TF="${{ steps.test.outputs.tests_failed }}"
          
          # Create PR body
          {
            echo "## 🔧 Updates"
            echo "- Go version → ${GO_VER}"
            echo "- Dependencies upgraded (safe upgrades only)"
            echo ""
            echo "## 📜 Changelog Diff"
            
            if [ -f changelog.md ]; then
              cat changelog.md
            else
              echo "_No changelog generated._"
            fi
            
            echo -e "\n## ✅ Test Status"
            if [ "${TF}" = "true" ]; then
              echo "❌ Tests failed — see test output below"
              echo '```'
              if [ -f test_output.txt ]; then
                cat test_output.txt
              else
                echo "No test output available"
              fi
              echo '```'
            else
              echo "✅ All tests passed"
            fi
          } > pr_body.md

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7.0.8
        with:
          token: ${{ secrets.GH_TOKEN }}
          commit-message: "chore: update Go ${{ steps.go-version.outputs.version }} and dependencies"
          branch: "update/go-${{ steps.go-version.outputs.version }}"
          title: "Update Go ${{ steps.go-version.outputs.version }} and dependencies"
          body-path: pr_body.md
          delete-branch: true
