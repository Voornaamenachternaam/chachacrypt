name: CI_qwen3

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'

permissions:
  contents: write
  pull-requests: write
  id-token: write

env:
  GOFLAGS: -mod=mod

jobs:
  ci:
    name: CI (ai-assisted deps + linters)
    runs-on: ubuntu-latest
    steps:

      - name: Checkout repository (full history)
        uses: actions/checkout@v5.0.0
        with:
          fetch-depth: 0
          persist-credentials: true
          clean: true

      - name: Setup Go (latest stable; no caching)
        uses: actions/setup-go@v6.0.0
        with:
          go-version: 'stable'
          check-latest: true
          cache: false

      - name: Verify go version
        run: |
          echo "Using go: $(go version)"
          go env

      - name: Run gitleaks (non-fatal)
        uses: gitleaks/gitleaks-action@v2.3.9
        continue-on-error: true
        with:
          args: "--redact"
        env:
          GITHUB_TOKEN: ${{ secrets.GH2_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: Ensure golangci-lint available (v2.5.0, no cache)
        uses: golangci/golangci-lint-action@v8.0.0
        with:
          version: v2.5.0
          install-mode: binary
          verify: true
          skip-cache: true
          skip-save-cache: true

      - name: Run AI refactor script (updates, build, AI loop)
        run: |
          set -euo pipefail
          chmod +x ./.github/scripts/ai_refactor.sh
          ./.github/scripts/ai_refactor.sh
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_ACTOR: ${{ github.actor }}
          OPENROUTER_ENDPOINT: https://api.openrouter.ai/v1/chat/completions
          MODEL: "deepseek/deepseek-r1-0528-qwen3-8b:free"

      - name: Upload artifacts (logs, diffs, patches)
        if: always()
        uses: actions/upload-artifact@v4.6.2
        with:
          name: ci-artifacts
          path: |
            ai-build.log
            ai-diff-before.patch
            ai-diff-after.patch
            ai-fix-*.patch
            ai-fix-*.log
            ai-lint.json
            ai-staticcheck.txt
            golangci-lint.json
            staticcheck.txt
          if-no-files-found: warn

      - name: Clean workspace of generated artifacts (prevent accidental commits)
        if: always()
        run: |
          set -euo pipefail
          rm -f ai-build.log ai-diff-before.patch ai-diff-after.patch ai-fix-*.patch ai-fix-*.log ai-lint.json ai-staticcheck.txt golangci-lint.json staticcheck.txt chachacrypt || true
          git clean -fdx || true
          git restore --staged . || true

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v7.0.8
        with:
          token: ${{ secrets.GH2_TOKEN }}
          commit-message: "chore: update Go toolchain & modules to latest (automated)"
          branch: ai/dep-updates
          branch-suffix: timestamp
          delete-branch: true
          title: "chore: automated dependency & Go toolchain upgrades (AI-assisted)"
          body: |
            Automated pull request that updates only:
            - go.mod
            - go.sum
            - chachacrypt.go (only if necessary)

            The CI attempted AI-assisted fixes where necessary to restore build/tests/lint compatibility. Please review changes.
            Artifacts from the run are available for inspection.
          add-paths: |
            go.mod
            go.sum
            chachacrypt.go
          labels: automated, dependencies, ai-assisted
          draft: false
