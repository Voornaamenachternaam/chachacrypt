name: CI_qwen3

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'

permissions:
  contents: write
  pull-requests: write
  id-token: write

env:
  GOFLAGS: -mod=mod

jobs:
  ci:
    name: CI (ai-assisted deps + linters)
    runs-on: ubuntu-latest
    steps:

      - name: Checkout repository (full history)
        uses: actions/checkout@v5.0.0
        with:
          fetch-depth: 0
          persist-credentials: true
          clean: true

      - name: Setup Go (latest stable; no caching)
        uses: actions/setup-go@v6.0.0
        with:
          go-version: 'stable'
          check-latest: true
          cache: false

      - name: Verify go version
        run: |
          echo "Using go: $(go version)"
          go env

      - name: Run gitleaks (non-fatal)
        uses: gitleaks/gitleaks-action@v2.3.9
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GH2_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: Ensure tooling (golangci-lint)
        run: |
          set -euo pipefail
          export GOPATH="$(go env GOPATH)"
          export PATH="$GOPATH/bin:$PATH"
          if ! command -v golangci-lint >/dev/null 2>&1; then
            echo "Installing golangci-lint..."
            go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
          fi
          golangci-lint --version || true

      - name: Run AI refactor script (updates, build, AI loop)
        id: ai-refactor
        run: |
          set -euo pipefail
          chmod +x ./.github/scripts/ai_refactor.sh
          ./.github/scripts/ai_refactor.sh
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GH2_TOKEN: ${{ secrets.GH2_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_ACTOR: ${{ github.actor }}

      - name: Upload artifacts (logs, diffs, patches)
        if: always()
        uses: actions/upload-artifact@v4.6.2
        with:
          name: ci-artifacts
          path: |
            ai-build.log
            ai-diff-before.patch
            ai-diff-after.patch
            ai-fix-*.patch
            ai-fix-*.log
            ai-lint.json
            ai-staticcheck.txt
            golangci-lint.json
            staticcheck.txt
          if-no-files-found: warn

      - name: Clean working tree of generated artifacts (prevent accidental commits)
        if: always()
        run: |
          set -euo pipefail
          rm -f ai-build.log ai-diff-before.patch ai-diff-after.patch ai-fix-*.patch ai-fix-*.log ai-lint.json ai-staticcheck.txt golangci-lint.json staticcheck.txt chachacrypt || true
          git clean -fdx || true
          git restore --staged . || true

      - name: Create Pull Request (if changes exist)
        if: ${{ steps.ai-refactor.outputs.create_pr == 'true' }}
        uses: peter-evans/create-pull-request@v7.0.8
        with:
          token: ${{ secrets.GH2_TOKEN }}
          branch: ${{ steps.ai-refactor.outputs.branch }}
          base: main
          title: "chore: automated dependency & Go toolchain upgrades (AI-assisted)"
          body: Automated pull request that updates only
            - go.mod
            - go.sum
            - chachacrypt.go (only if necessary)
            The CI attempted AI-assisted fixes (tngtech/deepseek-r1t2-chimera) where necessary to restore build/tests/lint compatibility. Please review changes.
          add-paths: |
            go.mod
            go.sum
            chachacrypt.go
          labels: automated, dependencies, ai-assisted
          draft: false
