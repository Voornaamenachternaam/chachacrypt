# .github/workflows/CI_qwen3.yml (revised)
name: CI_qwen3

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  golangci:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        go: [ 'stable' ]
        os: [ ubuntu-latest, windows-latest ]
    steps:
      - name: Checkout
        uses: actions/checkout@v5.0.0
        with:
          fetch-depth: 0
          persist-credentials: false
      - name: Setup Go (lint)
        uses: actions/setup-go@v6.0.0
        with:
          go-version: ${{ matrix.go }}
          check-latest: true
          cache: false
      # (golangci-lint steps as beforeâ€¦)

  ai-refactor:
    name: AI Refactor & PR
    runs-on: ubuntu-latest
    needs: golangci
    outputs:
      pr_branch: ${{ steps.ai_run.outputs.pr_branch }}
    steps:
      - name: Checkout (full)
        uses: actions/checkout@v5.0.0
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Go (for validation)
        uses: actions/setup-go@v6.0.0
        with:
          go-version: 'stable'
          check-latest: true
          cache: false

      - name: Copy CI artifacts
        run: |
          mkdir -p ci-artifacts/combined
          cp -r ci-artifacts/ubuntu-latest/* ci-artifacts/combined/ 2>/dev/null || true
          cp -r ci-artifacts/windows-latest/* ci-artifacts/combined/ 2>/dev/null || true
      - name: Ensure AI script is executable
        run: chmod +x .github/scripts/ai_refactor.sh

      - name: Run AI refactor script
        id: ai_run
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GH2_TOKEN: ${{ secrets.GH2_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_WORKSPACE: ${{ github.workspace }}
        run: |
          ./.github/scripts/ai_refactor.sh --artifacts "ci-artifacts/combined"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7.0.11
        with:
          token: ${{ secrets.GH2_TOKEN }}
          branch-token: ${{ secrets.GH2_TOKEN }}
          branch: ${{ steps.ai_run.outputs.pr_branch }}
          base: main
          title: "chore: automated dependency & code fixes (AI-assisted)"
          body: |
            Automated PR created by CI. The AI reviewed lint/build/test outputs and applied fixes to:
            - go.mod
            - go.sum
            - chachacrypt.go
            Please review changes and CI artifacts.
          labels: automated, dependencies, ai-assisted
          draft: false
          commit-message: "[create-pull-request] automated change"
          committer: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          author: ${{ github.actor }} <${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com>
