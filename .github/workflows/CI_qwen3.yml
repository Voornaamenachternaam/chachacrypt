name: CI_qwen3

on:
  schedule:
    - cron: '0 2 * * *'
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

env:
  ARTIFACT_DIR: ci-artifacts/combined

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6.0.1
        with:
          fetch-depth: 0

      - name: Determine Go version from go.mod
        id: goversion
        shell: bash
        run: |
          set -euo pipefail
          GO_VER=$(awk '/^go[[:space:]]+/{print $2; exit}' go.mod)
          echo "version=${GO_VER}" >> "$GITHUB_OUTPUT"

      - name: Set up Go (match go.mod)
        uses: actions/setup-go@v6.1.0
        with:
          go-version-file: 'go.mod'
          cache: false   # explicit: no caching per requirement

      - name: Snapshot dependency versions (pre)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p $RUNNER_TEMP/ci-snap
          cp go.mod "$RUNNER_TEMP/ci-snap/go.mod.pre"
          cp go.sum "$RUNNER_TEMP/ci-snap/go.sum.pre"

      - name: Run AI refactor script (creates PR via API)
        id: ai_run
        shell: bash
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENROUTER_MODEL: ${{ secrets.OPENROUTER_MODEL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GH2_TOKEN: ${{ secrets.GH2_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_WORKSPACE: ${{ github.workspace }}
        run: |
          ./.github/scripts/ai_refactor.sh --artifacts "${{ env.ARTIFACT_DIR }}"

      - name: Enforce no downgrades of Go or deps
        shell: bash
        run: |
          set -euo pipefail
          # checks are enforced by the script; this step acts as guard and prints a summary.
          echo "Pre/post snapshots are in $RUNNER_TEMP/ci-snap and ${GITHUB_WORKSPACE}/${{ env.ARTIFACT_DIR }}"

      - name: golangci-lint (fix, no annotations, no cache)
        uses: golangci/golangci-lint-action@v9.2.0
        with:
          version: latest
          skip-cache: true
          problem-matchers: false
          args: --fix

      - name: Build & test
        shell: bash
        run: |
          set -euo pipefail
          go build ./...
          go test ./...

      - name: Upload artifacts (raw model output, logs)
        uses: actions/upload-artifact@v6.0.0
        with:
          name: ci-artifacts
          path: ${{ env.ARTIFACT_DIR }}
          retention -days: 30

