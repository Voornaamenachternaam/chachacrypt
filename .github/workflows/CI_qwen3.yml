# /.github/workflows/CI_qwen3.yml
name: CI_qwen3

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *' # daily at 03:00 UTC (adjust as desired)

permissions:
  contents: write
  pull-requests: write
  id-token: write

env:
  GOFLAGS: -mod=mod

jobs:
  ci:
    name: CI (qwen3 + linters + deps)
    runs-on: ubuntu-latest
    steps:

      - name: Checkout repository (full history)
        uses: actions/checkout@v5.0.0
        with:
          fetch-depth: 0

      - name: Cache Go modules
        uses: actions/cache@v4.3.0
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Setup Go (latest stable)
        uses: actions/setup-go@v6
        with:
          go-version: 'stable'
        id: setup-go

      - name: Verify go version
        run: |
          echo "Using go: $(go version)"
          go env

      - name: Install golangci-lint (latest, binary)
        uses: golangci/golangci-lint-action@v8
        with:
          version: latest
          install-mode: binary

      - name: Install staticcheck (latest)
        run: |
          set -euo pipefail
          GO111MODULE=on go install honnef.co/go/tools/cmd/staticcheck@latest
          echo "staticcheck installed: $(staticcheck -version || true)"

      - name: Run gitleaks (non-fatal)
        uses: gitleaks/gitleaks-action@v2.3.9
        continue-on-error: true
        with:
          args: "--redact"
        env:
          GITHUB_TOKEN: ${{ secrets.GH2_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: Run AI refactor script (updates, build, AI loop)
        id: ai-refactor
        run: |
          set -euo pipefail
          # ensure script is executable
          chmod +x ./.github/scripts/ai_refactor.sh
          # run script; it will set the branch output to $GITHUB_OUTPUT
          ./.github/scripts/ai_refactor.sh
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GH2_TOKEN: ${{ secrets.GH2_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_ACTOR: ${{ github.actor }}

      - name: Run golangci-lint (collect results, non-fatal)
        run: |
          set -euo pipefail
          golangci-lint --version || true
          golangci-lint run --timeout=5m --out-format json ./... > golangci-lint.json || true
          # try automatic safe fixes if available; do not fail the job if it changes files
          golangci-lint run --fix --timeout=5m ./... || true
        continue-on-error: true

      - name: Run staticcheck (non-fatal)
        run: |
          set -euo pipefail
          staticcheck ./... > staticcheck.txt || true
        continue-on-error: true

      - name: Show summary logs
        if: always()
        run: |
          echo "=== go version ==="
          go version || true
          echo "=== go env ==="
          go env || true
          echo "=== last git commits ==="
          git --no-pager log -n 10 --pretty=oneline || true
          echo "=== golangci-lint summary (first 200 lines) ==="
          head -n 200 golangci-lint.json || true
          echo "=== staticcheck (first 200 lines) ==="
          head -n 200 staticcheck.txt || true

      - name: Upload artifacts (logs, diffs, patches)
        if: always()
        uses: actions/upload-artifact@v4.6.2
        with:
          name: ci-artifacts
          path: |
            golangci-lint.json
            staticcheck.txt
            ai-fix-*.patch
            ai-fix-*.log
            ai-build.log
            ai-diff-before.patch
            ai-diff-after.patch
            ai-lint.log

      - name: Create Pull Request (if branch created)
        if: ${{ steps.ai-refactor.outputs.branch != '' }}
        uses: peter-evans/create-pull-request@v7.0.8
        with:
          token: ${{ secrets.GH2_TOKEN }}
          title: "chore: automated dependency & Go toolchain upgrades (AI-assisted)"
          body: |
            Automated pull request that:
            - upgrades all Go modules to their latest versions (including major bumps)
            - bumps the module Go directive to the current stable Go
            - applies AI-assisted fixes (qwen/qwen3-coder) where necessary to restore build/tests/lint compatibility
            The CI attempted up to 5 AI iterations to fix compile/test/lint errors. Please review changes.
          head: ${{ steps.ai-refactor.outputs.branch }}
          base: main
          labels: automated, dependencies, ai-assisted
          draft: false
