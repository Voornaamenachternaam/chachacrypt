name: govet-autofix

on:
  push:
    branches:
      - main
      - 'release/**'
  pull_request:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

permissions:
  contents: write
  pull-requests: write
  checks: write
  statuses: write

jobs:
  lint-and-autofix:
    name: Lint, Attempt Fixes, Create PR (if issues)
    runs-on: ubuntu-latest
    env:
      REPORT_DIR: autofix-reports

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Go 1.25.6
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.6'
          cache: false

      - name: Prepare report directory
        run: |
          set -euo pipefail
          rm -rf "${REPORT_DIR}"
          mkdir -p "${REPORT_DIR}"

      - name: Print Go environment
        run: |
          go version
          go env

      - name: Install fieldalignment
        run: |
          set -euo pipefail
          go install golang.org/x/tools/go/analysis/passes/fieldalignment/cmd/fieldalignment@v0.41.0

      - name: Capture gofmt candidates
        id: gofmt-list
        run: |
          set -euo pipefail
          gofmt -s -l . > "${REPORT_DIR}/gofmt-files.txt" || true

      - name: Apply gofmt fixes
        run: |
          set -euo pipefail
          { gofmt -s -w . 2>&1 || true; } > "${REPORT_DIR}/gofmt-fix.txt" || true

      - name: Run go vet
        run: |
          set -euo pipefail
          { go vet ./... 2>&1 || true; } > "${REPORT_DIR}/govet.txt" || true

      - name: Run fieldalignment fixes
        run: |
          set -euo pipefail
          { fieldalignment -fix ./... 2>&1 || true; } > "${REPORT_DIR}/fieldalignment.txt" || true

      - name: Run go mod tidy
        run: |
          set -euo pipefail
          { go mod tidy 2>&1 || true; } > "${REPORT_DIR}/go-mod-tidy.txt" || true

      - name: Configure git
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"

      - name: Detect changes or reports
        id: detect
        run: |
          set -euo pipefail
          git add -A || true

          repo_changed=true
          if git diff --cached --quiet && git diff --quiet; then
            repo_changed=false
          fi

          report_found=false
          for f in ${REPORT_DIR}/*.txt; do
            [ -s "$f" ] && report_found=true && break
          done

          echo "repo_changed=${repo_changed}" >> $GITHUB_OUTPUT
          echo "report_found=${report_found}" >> $GITHUB_OUTPUT

          if [ "${repo_changed}" = "false" ] && [ "${report_found}" = "false" ]; then
            echo "create_pr=false" >> $GITHUB_OUTPUT
          else
            echo "create_pr=true" >> $GITHUB_OUTPUT
          fi

      - name: Create branch and commit
        id: branch
        if: steps.detect.outputs.create_pr == 'true'
        run: |
          set -euo pipefail
          BRANCH="auto-fixes/${GITHUB_RUN_ID}-${GITHUB_SHA::7}"
          git checkout -b "${BRANCH}"
          git add -A
          git commit -m "chore(autofix): apply automatic Go fixes and diagnostics [skip ci]" || true
          git push --force --set-upstream origin "${BRANCH}"
          echo "name=${BRANCH}" >> $GITHUB_OUTPUT

      - name: Create or update Pull Request
        if: steps.detect.outputs.create_pr == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.branch.outputs.name }}
          update-existing: true
          title: "[autofix] apply Go formatting, alignment fixes and diagnostics"
          commit-message: "chore(autofix): apply Go fixes and diagnostics [skip ci]"
          body: |
            This PR was created automatically.

            Included:
            - gofmt (-s)
            - fieldalignment (-fix)
            - go vet output
            - go mod tidy output

            Diagnostic logs are available in the `autofix-reports/` directory.

      - name: Nothing to fix
        if: steps.detect.outputs.create_pr == 'false'
        run: |
          echo "No fixes or diagnostics produced. No PR created."
