name: govet-autofix

on:
  push:
    branches:
      - main
      - 'release/**'
  pull_request:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

permissions:
  contents: write
  pull-requests: write
  checks: write
  statuses: write

jobs:
  lint-and-autofix:
    name: Lint, Attempt Fixes, Create PR if Needed
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Go 1.25.6
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.6'
          cache: false

      - name: Print Go environment
        run: |
          go version
          go env

      - name: Install fieldalignment
        run: |
          set -euo pipefail
          go install golang.org/x/tools/go/analysis/passes/fieldalignment/cmd/fieldalignment@v0.41.0

      - name: Run gofmt (apply fixes)
        run: |
          gofmt -s -w . || true

      - name: Run go vet (capture logs)
        run: |
          go vet ./... > "$RUNNER_TEMP/govet.log" 2>&1 || true

      - name: Run fieldalignment (apply fixes, capture logs)
        run: |
          fieldalignment -fix ./... > "$RUNNER_TEMP/fieldalignment.log" 2>&1 || true

      - name: Run go mod tidy
        run: |
          go mod tidy || true

      - name: Upload diagnostic logs
        uses: actions/upload-artifact@v6.0.0
        with:
          name: go-diagnostics
          path: |
            ${{ runner.temp }}/govet.log
            ${{ runner.temp }}/fieldalignment.log
          if-no-files-found: ignore

      - name: Detect repository changes
        id: changes
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create or update Pull Request
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: auto-fixes/${{ github.run_id }}
          update-existing: true
          commit-message: "chore(autofix): apply Go formatting and alignment fixes [skip ci]"
          title: "[autofix] Apply Go formatting and alignment fixes"
          body: |
            This PR was created automatically.

            Applied fixes:
            - gofmt (-s)
            - fieldalignment (-fix)
            - go mod tidy

            Diagnostic logs were uploaded as workflow artifacts.

      - name: No changes detected
        if: steps.changes.outputs.changed == 'false'
        run: |
          echo "No auto-fixable changes detected; no PR created."
