name: govet-autofix

on:
  push:
    branches:
      - main
      - 'release/**'
  pull_request:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

permissions:
  contents: write
  pull-requests: write
  checks: write
  statuses: write

jobs:
  lint-and-autofix:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.6'
          cache: false

      - name: Print Go info
        run: |
          go version
          go env

      - name: Install fieldalignment
        run: |
          set -euo pipefail
          go install golang.org/x/tools/go/analysis/passes/fieldalignment/cmd/fieldalignment@v0.41.0

      - name: Pre-fix checks (gofmt, govet, fieldalignment)
        run: |
          set -euo pipefail
          gofmt -s -w . || true
          go vet ./... > "$RUNNER_TEMP/govet-pre.log" 2>&1 || true
          fieldalignment -fix ./... > "$RUNNER_TEMP/fieldalignment-pre.log" 2>&1 || true
          go mod tidy || true

      - name: Create conservative auto-fix script
        run: |
          cat > "$RUNNER_TEMP/attempt_autofix.sh" <<'EOF'
#!/usr/bin/env bash
set -euo pipefail
tmp="$(mktemp)"
modified=0

process_file() {
  f="$1"
  # skip vendor and generated files
  case "$f" in
    */vendor/*|*_generated.go|*generated.go) return ;;
  esac
  # normalize nulls and CRLF
  if grep -q $'\x00' "$f" 2>/dev/null; then
    tr -d '\000' < "$f" > "$tmp"
    mv "$tmp" "$f"
    modified=1
  fi
  if grep -q $'\r' "$f" 2>/dev/null; then
    sed -i 's/\r$//' "$f"
    modified=1
  fi
  # remove vmodule lines anywhere
  if grep -q '^vmodule[[:space:]]' "$f" 2>/dev/null; then
    sed -i '/^vmodule[[:space:]]/d' "$f"
    modified=1
  fi
  # remove leading module/go/toolchain lines within first 60 lines
  if head -n60 "$f" | grep -Eq '^(module[[:space:]]+|go[[:space:]]+[0-9]|toolchain[[:space:]]+)'; then
    awk 'NR<=60{ if (/^(module[[:space:]]+|go[[:space:]]+[0-9]|toolchain[[:space:]]+)/) next } { print }' "$f" > "$tmp"
    tail -n +61 "$f" >> "$tmp" 2>/dev/null || true
    if ! cmp -s "$f" "$tmp"; then mv "$tmp" "$f"; modified=1; fi
  fi
  # remove simple merge conflict blocks
  if grep -q '^<<<<<<< ' "$f" 2>/dev/null || grep -q '^>>>>>>>' "$f" 2>/dev/null; then
    awk 'BEGIN{skip=0}
         /^<<<<<<< /{skip=1; next}
         /^>>>>>>> /{skip=0; next}
         skip==0 { print }' "$f" > "$tmp"
    if ! cmp -s "$f" "$tmp"; then mv "$tmp" "$f"; modified=1; fi
  fi
  # run gofmt per-file
  gofmt -s -w "$f" || true
}

export -f process_file
find . -type f -name '*.go' -print0 | xargs -0 -n1 -I{} bash -c 'process_file "{}"'
if [ "$modified" -ne 0 ]; then
  git add -A
fi
rm -f "$tmp"
EOF
          chmod +x "$RUNNER_TEMP/attempt_autofix.sh"

      - name: Run conservative auto-fixer
        run: |
          set -euo pipefail
          "$RUNNER_TEMP/attempt_autofix.sh" || true

      - name: Post-fix checks (gofmt, govet, fieldalignment)
        run: |
          set -euo pipefail
          gofmt -s -w . || true
          go vet ./... > "$RUNNER_TEMP/govet-post.log" 2>&1 || true
          fieldalignment -fix ./... > "$RUNNER_TEMP/fieldalignment-post.log" 2>&1 || true
          go mod tidy || true

      - name: Upload diagnostic logs
        uses: actions/upload-artifact@v6.0.0
        with:
          name: go-diagnostics
          path: |
            ${{ runner.temp }}/govet-pre.log
            ${{ runner.temp }}/fieldalignment-pre.log
            ${{ runner.temp }}/govet-post.log
            ${{ runner.temp }}/fieldalignment-post.log
          if-no-files-found: ignore

      - name: Prepare commit and detect changes
        id: changes
        run: |
          set -euo pipefail
          git add -A || true
          if git diff --cached --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            git commit -m "chore(autofix): apply formatting and safe repairs [skip ci]" || true
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create or update PR
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: auto-fixes/${{ github.run_id }}
          base: main
          update-existing: 'true'
          commit-message: "chore(autofix): apply formatting and safe repairs [skip ci]"
          title: "[autofix] Apply safe automatic repairs and formatting"
          body: |
            Automatic fixes applied where safe. Diagnostic logs are attached as workflow artifacts.
