name: Superlint

# Run when a PR is created/updated
on:
  pull_request:
    types: [opened, synchronize, reopened, edited, ready_for_review]
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

# minimal workflow-level permission; per-job overrides below
permissions:
  actions: write
  checks: write
  contents: write
  deployments: write
  id-token: write
  issues: write
  discussions: write
  packages: write
  pages: write
  pull-requests: write
  repository-projects: write
  security-events: write
  statuses: write

concurrency:
  group: superlinter-fix-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint (check-only)
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      contents: write
      checks: write
      pull-requests: write
    steps:
      - name: Checkout (for lint check)
        uses: actions/checkout@v6.0.0
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Super-Linter (check-only)
        uses: super-linter/super-linter@v8.2.1
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ github.token }}
          VALIDATE_GO: true
          VALIDATE_GO_MODULES: true

  fix-go:
    name: Fix Go (autofix) and open fixes PR -> target main
    runs-on: ubuntu-latest
    continue-on-error: true

    # Run for PR events or manual dispatch; still skip common bot actors
    if: >
      (github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch') &&
      github.actor != 'github-actions[bot]' &&
      github.actor != 'dependabot[bot]'

    permissions:
      contents: write
      pull-requests: write
      checks: write
      statuses: write

    steps:
      - name: Checkout PR head branch (full history, no persisted creds)
        uses: actions/checkout@v6.0.0
        with:
          # robust ref selection for PR vs workflow_dispatch runs
          ref: ${{ github.event.pull_request.head.ref || github.head_ref || github.ref_name || github.ref }}
          fetch-depth: 0
          persist-credentials: false

      - name: Use Go version from repository's go.mod (no cache)
        uses: actions/setup-go@v6.1.0
        with:
          go-version-file: 'go.mod'
          cache: false
          token: ${{ github.token }}

      - name: Super-Linter (auto-fix for Go)
        uses: super-linter/super-linter@v8.2.1
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ github.token }}
          VALIDATE_GO: true
          VALIDATE_GO_MODULES: true
          FIX_GO: true
          FIX_GO_MODULES: true

      - name: Run go mod tidy for every tracked module (explicit)
        run: |
          set -euo pipefail
          echo "Finding tracked go.mod files..."
          mapfile -t mods < <(git ls-files -- '*/go.mod' 'go.mod' || true)
          if [ ${#mods[@]} -eq 0 ]; then
            echo "No go.mod files found."
            exit 0
          fi
          for gm in "${mods[@]}"; do
            moddir=$(dirname "$gm")
            echo "Running 'go mod tidy' in: $moddir"
            (cd "$moddir" && go mod tidy)
          done
        shell: bash

      - name: Upload Super-Linter output as artifact (always)
        if: always()
        uses: actions/upload-artifact@v5.0.0
        with:
          name: super-linter-output-${{ github.run_id }}
          path: |
            super-linter-output
            super-linter-report.html
            super-linter-report.json

      - name: Ensure working tree is clean (remove linter output / other untracked files)
        run: |
          # Remove commonly created linter output to avoid branch-checkout conflicts.
          # This does not affect the uploaded artifact (upload already happened).
          set -euo pipefail
          if [ -d "super-linter-output" ]; then
            rm -rf super-linter-output || true
          fi
          # Remove other known generated files that might block checkout (optional safety)
          rm -f super-linter-report.html || true
          rm -f super-linter-report.json || true
          # Remove any remaining untracked files to guarantee clean checkout for PR action.
          git clean -fdx || true
        shell: bash

      - name: Prepare fixes branch name (minimal, deterministic)
        id: branchname
        run: |
          src="${GITHUB_HEAD_REF:-${GITHUB_REF_NAME:-${GITHUB_REF##*/}}}"
          if [ -z "$src" ]; then
            src="unknown"
          fi
          safe_src=$(echo "$src" | tr '/ ' '-' | tr -cd '[:alnum:]-' | sed 's/^-*//;s/-*$//')
          echo "branch=super-linter/fixes-${safe_src}-${GITHUB_RUN_ID}" >> "$GITHUB_OUTPUT"

      - name: Create or update Pull Request with fixes
        id: create_pr
        uses: peter-evans/create-pull-request@v7.0.8
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          branch: ${{ steps.branchname.outputs.branch }}
          base: main
          title: "[super-linter] apply Go fixes for ${{ github.event.pull_request.number }} -> main"
          body: |
            Automated Go fixes from Super-Linter (gofmt/goimports and any autofixes available), plus an explicit `go mod tidy`.
            If there are no changes, no PR will be created.
          commit-message: "chore(lint): apply super-linter/go fixes [skip ci]"
          author: "super-linter[bot] <super-linter@super-linter.dev>"

      - name: Print created/updated PR url (if created)
        if: ${{ steps.create_pr.outputs.pull-request-number != '' }}
        run: |
          echo "Fixes PR created/updated: https://github.com/${{ github.repository }}/pull/${{ steps.create_pr.outputs.pull-request-number }}"
 
