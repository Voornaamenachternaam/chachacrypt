name: Superlint

# Run when a PR is created/updated
on:
  pull_request:
    types: [opened, synchronize, reopened, edited, ready_for_review]
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

# minimal workflow-level permission; per-job overrides below
permissions:
  actions: write
  checks: write
  contents: write
  deployments: write
  id-token: write
  issues: write
  discussions: write
  packages: write
  pages: write
  pull-requests: write
  repository-projects: write
  security-events: write
  statuses: write

concurrency:
  group: superlinter-fix-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint (check-only)
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      contents: write
      checks: write
      pull-requests: write
    steps:
      - name: Checkout (for lint check)
        uses: actions/checkout@v6.0.0
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Super-Linter (check-only)
        uses: super-linter/super-linter@v8.2.1
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ github.token }}
          VALIDATE_GO: true
          VALIDATE_GO_MODULES: true

  fix-go:
    name: Fix Go (autofix) and open fixes PR -> target main
    runs-on: ubuntu-latest
    continue-on-error: true

    # Run for all events (PR, workflow_dispatch, schedule) for human actors.
    # This avoids the 'This job was skipped' case you experienced when running via workflow_dispatch.
    if: >
      github.actor != 'github-actions[bot]' &&
      github.actor != 'dependabot[bot]'

    permissions:
      contents: write
      pull-requests: write
      checks: write
      statuses: write

    steps:
      - name: Checkout target branch / head (full history, no persisted creds)
        uses: actions/checkout@v6.0.0
        with:
          # robust ref selection for PR vs workflow_dispatch runs
          ref: ${{ github.event.pull_request.head.ref || github.head_ref || github.ref_name || github.ref }}
          fetch-depth: 0
          persist-credentials: false

      - name: Use Go version from repository's go.mod (no cache)
        uses: actions/setup-go@v6.1.0
        with:
          go-version-file: 'go.mod'
          cache: false
          token: ${{ github.token }}

      - name: Super-Linter (auto-fix for Go)
        uses: super-linter/super-linter@v8.2.1
        continue-on-error: true
        env:
          # token
          GITHUB_TOKEN: ${{ github.token }}

          # enable Go fixes
          VALIDATE_GO: true
          VALIDATE_GO_MODULES: true
          FIX_GO: true
          FIX_GO_MODULES: true

          # IMPORTANT: prevent super-linter from writing output files that break git checkouts.
          # These tell Super-Linter NOT to save outputs or write the markdown summary into the workspace.
          SAVE_SUPER_LINTER_OUTPUT: 'false'
          SAVE_SUPER_LINTER_SUMMARY: 'false'
          ENABLE_GITHUB_ACTIONS_STEP_SUMMARY: 'false'

      - name: Run go mod tidy for every tracked module (explicit)
        run: |
          set -euo pipefail
          mapfile -t mods < <(git ls-files -- '*/go.mod' 'go.mod' || true)
          if [ ${#mods[@]} -eq 0 ]; then
            echo "No go.mod files found."
            exit 0
          fi
          for gm in "${mods[@]}"; do
            moddir=$(dirname "$gm")
            echo "Running 'go mod tidy' in: $moddir"
            (cd "$moddir" && go mod tidy)
          done
        shell: bash

      - name: Create an artifacts status file (always) - minimal, required artifact upload
        if: always()
        run: |
          set -euo pipefail
          mkdir -p .super-linter-artifacts
          cat > .super-linter-artifacts/run-info.txt <<'EOF'
          run_id=${{ github.run_id }}
          repo=${{ github.repository }}
          actor=${{ github.actor }}
          event=${{ github.event_name }}
          ref=${{ github.ref }}
          EOF
        shell: bash

      - name: Upload run status artifact (always)
        if: always()
        uses: actions/upload-artifact@v5.0.0
        with:
          name: superlinter-run-info-${{ github.run_id }}
          path: .super-linter-artifacts

      - name: Ensure workspace is clean (safety)
        run: |
          # If the linter or any step created files, remove them before create-pull-request.
          # This is defensive: we already disabled Super-Linter outputs, but keep cleanup to be safe.
          set -euo pipefail
          rm -rf super-linter-output || true
          rm -f super-linter-report.html super-linter-report.json || true
          # Remove our temporary artifact folder (artifact already uploaded)
          rm -rf .super-linter-artifacts || true
          # remove any other untracked files to guarantee clean checkout for PR action
          git clean -fdx || true
        shell: bash

      - name: Prepare fixes branch name (minimal, deterministic)
        id: branchname
        run: |
          src="${GITHUB_HEAD_REF:-${GITHUB_REF_NAME:-${GITHUB_REF##*/}}}"
          if [ -z "$src" ]; then
            src="unknown"
          fi
          safe_src=$(echo "$src" | tr '/ ' '-' | tr -cd '[:alnum:]-' | sed 's/^-*//;s/-*$//')
          echo "branch=super-linter/fixes-${safe_src}-${GITHUB_RUN_ID}" >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Create or update Pull Request with fixes
        id: create_pr
        uses: peter-evans/create-pull-request@v7.0.8
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          branch: ${{ steps.branchname.outputs.branch }}
          base: main
          title: "[super-linter] apply Go fixes for ${{ github.event.pull_request.number }} -> main"
          body: |
            Automated Go fixes from Super-Linter (gofmt/goimports and any autofixes available), plus an explicit `go mod tidy`.
            If there are no changes, no PR will be created.
          commit-message: "chore(lint): apply super-linter/go fixes [skip ci]"
          author: "super-linter[bot] <super-linter@super-linter.dev>"

      - name: Print created/updated PR url (if created)
        if: ${{ steps.create_pr.outputs.pull-request-number != '' }}
        run: |
          echo "Fixes PR created/updated: https://github.com/${{ github.repository }}/pull/${{ steps.create_pr.outputs.pull-request-number }}"
        shell: bash
 
