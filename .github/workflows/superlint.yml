name: Superlint

# Run when a PR is created/updated
on:
  pull_request:
    types: [opened, synchronize, reopened, edited, ready_for_review]
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

# minimal workflow-level permission; per-job overrides below
permissions:
  actions: write
  checks: write
  contents: write
  deployments: write
  id-token: write
  issues: write
  discussions: write
  packages: write
  pages: write
  pull-requests: write
  repository-projects: write
  security-events: write
  statuses: write

concurrency:
  group: superlinter-fix-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint (check-only)
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      contents: read
      checks: write
      pull-requests: write
    steps:
      - name: Checkout (for lint check)
        uses: actions/checkout@v6.0.0
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Super-Linter (check-only)
        uses: super-linter/super-linter@v8.2.1
        continue-on-error: true
        env:
          # use repository token provided to workflow (no PAT)
          GITHUB_TOKEN: ${{ github.token }}
          VALIDATE_GO: true
          VALIDATE_GO_MODULES: true

  fix-go:
    name: Fix Go (autofix) and open fixes PR -> target main
    runs-on: ubuntu-latest
    needs: lint
    continue-on-error: false

    # Avoid running on bot actors (reduces recursion/loops)
    if: >
      github.event_name == 'pull_request' &&
      github.actor != 'github-actions[bot]' &&
      github.actor != 'dependabot[bot]'

    permissions:
      contents: write
      pull-requests: write
      checks: write
      statuses: write

    steps:
      - name: Checkout PR head branch (full history, no persisted creds)
        # persist-credentials: false so pushes from PR-creator action use GITHUB_TOKEN
        uses: actions/checkout@v6.0.0
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
          persist-credentials: false

      - name: Use Go version from repository's go.mod (no cache)
        uses: actions/setup-go@v6.1.0
        with:
          # read the go version from /go.mod in repo root
          go-version-file: 'go.mod'
          cache: false
          # explicit token is not required for public repos; action defaults to github.token
          token: ${{ github.token }}

      - name: Super-Linter (auto-fix for Go)
        uses: super-linter/super-linter@v8.2.1
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ github.token }}
          VALIDATE_GO: true
          VALIDATE_GO_MODULES: true
          FIX_GO: true
          FIX_GO_MODULES: true
          # If you want only Go to be considered, uncomment this:
          # FILTER_REGEX_INCLUDE: '.*\.go$'

      - name: Run go mod tidy for every module (explicit, deterministic)
        # if a module's go.mod was changed by Super-Linter (or needs tidy), this ensures go.mod/go.sum are tidy
        run: |
          set -euo pipefail
          echo "Looking for go.mod files tracked by git..."
          # List only tracked go.mod files to avoid vendor/tmp scanning
          mapfile -t mods < <(git ls-files -- '*/go.mod' 'go.mod' || true)
          if [ ${#mods[@]} -eq 0 ]; then
            echo "No go.mod files found."
            exit 0
          fi
          for gm in "${mods[@]}"; do
            moddir=$(dirname "$gm")
            echo "Running 'go mod tidy' in: $moddir"
            (cd "$moddir" && go mod tidy)
          done
        shell: bash

      - name: Configure git user for automated commit
        run: |
          git config user.name "super-linter[bot]"
          git config user.email "super-linter@super-linter.dev"

      - name: Prepare fixes branch name
        id: branchname
        run: |
          # sanitize source branch name for readability, append run id for uniqueness
          src="${GITHUB_HEAD_REF:-${GITHUB_REF_NAME:-unknown}}"
          safe_src=$(echo "$src" | tr '/ ' '-' | tr -cd '[:alnum:]-' | sed 's/^-*//;s/-*$//')
          echo "branch=super-linter/fixes-${safe_src}-${{ github.run_id }}" >> $GITHUB_OUTPUT

      - name: Create or update Pull Request with fixes
        id: create_pr
        # persist-credentials must be false in checkout above so this step uses GITHUB_TOKEN
        uses: step-security/create-or-update-pull-request-action@v1.10.2
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          # The branch to push changes to (source branch of the PR created by this action)
          branch: ${{ steps.branchname.outputs.branch }}
          # Ensure the PR target (base) is main (explicit)
          base: main
          title: "[super-linter] apply Go fixes for ${{ github.event.pull_request.number }} -> main"
          body: |
            This PR contains automatic Go formatting/module fixes generated by Super-Linter (gofmt/goimports, golangci-lint autofixes, and an explicit `go mod tidy`).
            The PR targets **main** so you can review/merge the fixes into your main branch as requested.
            If no fixes were necessary, no PR will be created/updated.
          commit-message: "chore(lint): apply super-linter/go fixes [skip ci]"

      - name: Print created/updated PR url (if created)
        if: ${{ steps.create_pr.outputs.pull-request-number != '' }}
        run: |
          echo "Fixes PR created/updated: https://github.com/${{ github.repository }}/pull/${{ steps.create_pr.outputs.pull-request-number }}"
