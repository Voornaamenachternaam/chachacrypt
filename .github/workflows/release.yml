name: Release (GoReleaser + SBOM + Cosign verify)

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write
  id-token: write       # required for keyless Cosign (OIDC)
  actions: read

concurrency:
  group: release-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  test:
    name: Test & Lint
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout (full history & tags)
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Go 1.25.4 (no cache)
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.4'
          cache: false

      - name: Ensure modules
        run: go mod download

      - name: golangci-lint (install-only)
        uses: golangci/golangci-lint-action@v8
        with:
          install-only: true

      - name: Run go vet
        run: go vet ./...

      - name: Run tests
        run: go test ./... -v

  release:
    name: Build, SBOM, Sign, Verify, Release
    needs: test
    runs-on: ubuntu-latest
    timeout-minutes: 90
    env:
      GITHUB_TOKEN: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
      COSIGN_EXPERIMENTAL: '1'
    steps:
      - name: Checkout (full history & tags)
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Wipe local Go caches & previous dist (NO CACHE)
        run: |
          set -eux
          rm -rf "$HOME/.cache/go-build" || true
          rm -rf "$HOME/go/pkg/mod" || true
          rm -rf "/home/runner/go/pkg/mod" || true
          rm -rf "/home/runner/.cache/go-build" || true
          rm -rf dist || true
          echo "Local caches and dist/ removed."

      - name: Set SOURCE_DATE_EPOCH (robust)
        id: sde
        run: |
          set -eux
          sha=${GITHUB_SHA:-$(git rev-parse --verify HEAD 2>/dev/null || true)}
          if [ -z "$sha" ]; then
            echo "SOURCE_DATE_EPOCH=" >> $GITHUB_ENV
            echo "Warning: no commit SHA found; SOURCE_DATE_EPOCH left empty"
          else
            ts=$(git show -s --format=%ct "$sha" 2>/dev/null || true)
            echo "SOURCE_DATE_EPOCH=${ts:-}" >> $GITHUB_ENV
            echo "SOURCE_DATE_EPOCH set to ${ts:-}"
          fi

      - name: Setup Go 1.25.4 (release job; no cache)
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.4'
          cache: false

      - name: Install system deps (UPX + tar + zip)
        run: |
          sudo apt-get update
          sudo apt-get install -y upx zip tar

      - name: Install Cosign (keyless signing)
        uses: step-security/cosign-installer@v4

      - name: Check GoReleaser config (v2 schema)
        uses: goreleaser/goreleaser-action@v6.4.0
        with:
          args: check --config .goreleaser.yml
        env:
          GITHUB_TOKEN: ${{ env.GITHUB_TOKEN }}
          SOURCE_DATE_EPOCH: ${{ env.SOURCE_DATE_EPOCH }}

      - name: Run GoReleaser (builds, UPX, archives, checksums, release)
        uses: goreleaser/goreleaser-action@v6.4.0
        with:
          args: release --clean --config .goreleaser.yml
        env:
          GITHUB_TOKEN: ${{ env.GITHUB_TOKEN }}
          SOURCE_DATE_EPOCH: ${{ env.SOURCE_DATE_EPOCH }}
          COSIGN_EXPERIMENTAL: ${{ env.COSIGN_EXPERIMENTAL }}

      - name: Show produced artifacts (debug)
        if: always()
        run: ls -al dist || true

      - name: Generate SBOM (SPDX JSON)
        uses: anchore/sbom-action@v0.20.9
        with:
          path: dist
          format: spdx-json
          artifact-name: sbom-dist.spdx.json

      - name: Generate SBOM (CycloneDX JSON)
        uses: anchore/sbom-action@v0.20.9
        with:
          path: dist
          format: cyclonedx-json
          artifact-name: sbom-dist.cdx.json

      - name: Cosign sign artifacts (keyless, produce .cosign.bundle) - NON-INTERACTIVE & SAFE
        run: |
          set -eux
          cd dist
          for path in *; do
            case "$path" in
              *.cosign.bundle|*sbom*|*SHA256SUMS|*.spdx.json|*.cdx.json) echo "Skipping meta $path"; continue ;;
              README*|LICENSE*|CHANGELOG*|*.md) echo "Skipping doc $path"; continue ;;
            esac
            if [ -d "$path" ]; then
              base=$(basename "$path")
              tarname="${base}.tar.gz"
              echo "Archiving directory $path -> $tarname"
              tar -C "$path" -czf "$tarname" .
              target="$tarname"
            elif [ -f "$path" ]; then
              target="$path"
            else
              echo "Skipping non-regular $path"
              continue
            fi

            case "$target" in
              *.tar.gz|*.zip|*.exe|*.msi|*.deb|*.rpm)
                echo "Signing $target"
                COSIGN_EXPERIMENTAL=1 cosign sign-blob --yes --bundle "${target}.cosign.bundle" "$target"
                ;;
              *)
                if [ -f "$target" ] && [ -x "$target" ]; then
                  echo "Signing executable $target"
                  COSIGN_EXPERIMENTAL=1 cosign sign-blob --yes --bundle "${target}.cosign.bundle" "$target"
                else
                  echo "Skipping unrecognized artifact $target"
                fi
                ;;
            esac
          done
        env:
          GITHUB_TOKEN: ${{ env.GITHUB_TOKEN }}
          SOURCE_DATE_EPOCH: ${{ env.SOURCE_DATE_EPOCH }}
          COSIGN_EXPERIMENTAL: ${{ env.COSIGN_EXPERIMENTAL }}

      - name: Verify cosign bundles (pre-upload verification, keyless)
        run: |
          set -eux
          cd dist
          # Recommended: restrict identity regex to your repository/organization to avoid false positives.
          ID_REGEX="^https://github\\.com/${{ github.repository }}/.+"
          OIDC_ISSUER="https://token.actions.githubusercontent.com"
          for f in *; do
            case "$f" in
              *.cosign.bundle) continue ;;
            esac
            if [ -f "${f}.cosign.bundle" ]; then
              echo "Verifying $f"
              # Keyless verification requires certificate identity (or regexp) and oidc issuer.
              COSIGN_EXPERIMENTAL=1 cosign verify-blob --bundle "${f}.cosign.bundle" \
                --certificate-identity-regexp "$ID_REGEX" \
                --certificate-oidc-issuer "$OIDC_ISSUER" \
                "$f"
            fi
          done
        env:
          COSIGN_EXPERIMENTAL: ${{ env.COSIGN_EXPERIMENTAL }}

      - name: Attach SBOMs & Cosign bundles to the Release
        uses: step-security/action-gh-release@v2.4.1
        with:
          token: ${{ env.GITHUB_TOKEN }}
          files: |
            dist/*.spdx.json
            dist/*.cdx.json
            dist/*.cosign.bundle
            dist/*.tar.gz
            dist/*.zip
            dist/*.exe
            dist/*.deb
            dist/*.rpm

      - name: Final dist listing (always)
        if: always()
        run: ls -al dist || true
