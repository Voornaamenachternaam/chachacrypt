name: Release (GoReleaser + SBOM + Cosign verify)

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write
  id-token: write
  actions: read

concurrency:
  group: release-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  test:
    name: Test & Lint
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout (full history & tags)
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Go 1.25.4
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.4'

      - name: Cache Go build & modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Ensure modules
        run: go mod download

      - name: golangci-lint (install only)
        uses: golangci/golangci-lint-action@v8
        with:
          install-only: true

      - name: Run go vet
        run: go vet ./...

      - name: Run tests
        run: go test ./... -v

  release:
    name: Build, SBOM, Sign, Verify, Release
    needs: test
    runs-on: ubuntu-latest
    timeout-minutes: 90
    env:
      GITHUB_TOKEN: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout (full history & tags)
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Set SOURCE_DATE_EPOCH (reproducible build timestamp)
        id: sde
        run: |
          # robustly get commit to use for timestamp: prefer GITHUB_SHA, else HEAD
          sha=${GITHUB_SHA:-$(git rev-parse --verify HEAD 2>/dev/null || true)}
          if [ -z "$sha" ]; then
            echo "SOURCE_DATE_EPOCH=" >> $GITHUB_ENV
            echo "Warning: no commit SHA found; SOURCE_DATE_EPOCH left empty"
          else
            ts=$(git show -s --format=%ct "$sha" 2>/dev/null || true)
            echo "SOURCE_DATE_EPOCH=${ts:-}" >> $GITHUB_ENV
            echo "SOURCE_DATE_EPOCH set to ${ts:-}"
          fi

      - name: Cache Go build & modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Setup Go 1.25.4
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.4'

      - name: Install system deps (UPX + zip)
        run: |
          sudo apt-get update
          sudo apt-get install -y upx zip

      - name: Install Cosign (keyless signing)
        uses: step-security/cosign-installer@v4

      - name: Check GoReleaser config (v2 schema)
        uses: goreleaser/goreleaser-action@v6.4.0
        with:
          args: check --config .goreleaser.yml
        env:
          GITHUB_TOKEN: ${{ env.GITHUB_TOKEN }}
          SOURCE_DATE_EPOCH: ${{ env.SOURCE_DATE_EPOCH }}

      - name: Run GoReleaser (builds, UPX, archives, checksums, release)
        uses: goreleaser/goreleaser-action@v6.4.0
        with:
          # v2: use --clean (replaces removed --rm-dist). Also pass your config file.
          args: release --clean --config .goreleaser.yml
        env:
          GITHUB_TOKEN: ${{ env.GITHUB_TOKEN }}
          SOURCE_DATE_EPOCH: ${{ env.SOURCE_DATE_EPOCH }}
          COSIGN_EXPERIMENTAL: '1'

      - name: Show produced artifacts (for debug)
        if: always()
        run: ls -al dist || true

      - name: Generate SBOM (SPDX JSON)
        uses: anchore/sbom-action@v0.20.9
        with:
          path: dist
          format: spdx-json
          artifact-name: sbom-dist.spdx.json

      - name: Generate SBOM (CycloneDX JSON)
        uses: anchore/sbom-action@v0.20.9
        with:
          path: dist
          format: cyclonedx-json
          artifact-name: sbom-dist.cdx.json

      - name: Cosign sign all artifacts (keyless, produce .cosign.bundle)
        run: |
          set -eux
          cd dist
          for f in *; do
            case "$f" in
              *.cosign.bundle|*sbom*|*SHA256SUMS) continue ;;
            esac
            echo "Signing $f"
            cosign sign-blob --bundle "${f}.cosign.bundle" "$f"
          done

      - name: Verify cosign bundles (pre-upload verification)
        run: |
          set -eux
          cd dist
          for f in *; do
            case "$f" in
              *.cosign.bundle) continue ;;
            esac
            if [ -f "${f}.cosign.bundle" ]; then
              echo "Verifying $f"
              cosign verify-blob --bundle "${f}.cosign.bundle" "$f"
            else
              echo "No cosign bundle for $f"
            fi
          done

      - name: Attach SBOMs & Cosign bundles to the Release
        uses: step-security/action-gh-release@v2.4.1
        with:
          token: ${{ env.GITHUB_TOKEN }}
          files: |
            dist/*.spdx.json
            dist/*.cdx.json
            dist/*.cosign.bundle

      - name: Final dist listing (always)
        if: always()
        run: ls -al dist || true
