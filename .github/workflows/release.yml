name: Release (GoReleaser + SBOM + Cosign verify)

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write       # upload release assets
  packages: write
  id-token: write       # required for keyless Cosign (OIDC)
  actions: read

concurrency:
  group: release-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  # -------------------------------------------------------------------------
  # 1) Test & lint job (gates the release)
  #    - This is implemented here rather than calling the repo-local file
  #      directly to ensure the gating behavior is always present.
  #    - If your repo's .github/workflows/reviewdog.yml is a reusable workflow
  #      (on: workflow_call), you can replace the steps below with:
  #        uses: ./.github/workflows/reviewdog.yml
  #      (left as a comment below where appropriate).
  # -------------------------------------------------------------------------
  test:
    name: Test & Lint
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v5.0.0
        with:
          fetch-depth: 0

      - name: Setup Go 1.25.4
        uses: actions/setup-go@v6.0.0
        with:
          go-version: '1.25.4'

      - name: Cache Go build & modules
        uses: actions/cache@v4.3.0
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Ensure modules
        run: go mod download

      - name: Install golangci-lint (pinned version)
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b "$GOPATH/bin" v2.6.1

      - name: Run go vet
        run: go vet ./...

      - name: Run tests
        run: go test ./... -v

      - name: Run linter
        run: golangci-lint run ./...

  # -------------------------------------------------------------------------
  # 2) Release job (builds, sbom, sign, verify, publish)
  #    - Needs the 'test' gate above
  # -------------------------------------------------------------------------
  release:
    name: Build, SBOM, Sign, Verify, Release
    needs: test
    runs-on: ubuntu-latest
    timeout-minutes: 90
    env:
      # Prefer explicit token if provided, otherwise fallback to default GITHUB_TOKEN
      GITHUB_TOKEN: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v5.0.0
        with:
          fetch-depth: 0

      - name: Set SOURCE_DATE_EPOCH (reproducible build timestamp)
        id: sde
        run: |
          echo "SOURCE_DATE_EPOCH=$(git show -s --format=%ct $GITHUB_SHA)" >> $GITHUB_ENV
          echo "SOURCE_DATE_EPOCH set to $SOURCE_DATE_EPOCH"

      - name: Cache Go build & modules
        uses: actions/cache@v4.3.0
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Setup Go 1.25.4
        uses: actions/setup-go@v6.0.0
        with:
          go-version: '1.25.4'

      - name: Install system deps (UPX + zip)
        run: |
          sudo apt-get update
          sudo apt-get install -y upx zip

      - name: Install Cosign (keyless signing)
        uses: step-security/cosign-installer@v4.0.0
        with:
          cosign-release: 'latest'

      - name: Run GoReleaser (builds, UPX, archives, checksums, release)
        uses: goreleaser/goreleaser-action@v6.4.0
        with:
          args: release --rm-dist --config .goreleaser.yml
        env:
          GITHUB_TOKEN: ${{ env.GITHUB_TOKEN }}
          SOURCE_DATE_EPOCH: ${{ env.SOURCE_DATE_EPOCH }}
          COSIGN_EXPERIMENTAL: '1'

      - name: Show produced artifacts (for debug)
        if: always()
        run: ls -al dist || true

      - name: Generate SBOM (SPDX JSON)
        uses: anchore/sbom-action@v0.20.9
        with:
          path: dist
          format: spdx-json
          artifact-name: sbom-dist.spdx.json

      - name: Generate SBOM (CycloneDX JSON)
        uses: anchore/sbom-action@v0.20.9
        with:
          path: dist
          format: cyclonedx-json
          artifact-name: sbom-dist.cdx.json

      - name: Cosign sign all artifacts (keyless, produce .cosign.bundle)
        # keyless signing via OIDC; id-token: write permission required above
        run: |
          set -eux
          cd dist
          for f in *; do
            # skip pre-existing bundles, sboms, and the combined checksum file (we can sign it too but we sign everything here)
            case "$f" in
              *.cosign.bundle|*sbom*|*SHA256SUMS) continue ;;
            esac
            echo "Signing $f"
            cosign sign-blob --bundle "${f}.cosign.bundle" "$f"
          done

      - name: Verify cosign bundles (pre-upload verification)
        run: |
          set -eux
          cd dist
          for f in *; do
            # skip bundles themselves
            case "$f" in
              *.cosign.bundle) continue ;;
            esac
            if [ -f "${f}.cosign.bundle" ]; then
              echo "Verifying $f"
              cosign verify-blob --bundle "${f}.cosign.bundle" "$f"
            else
              echo "No cosign bundle for $f"
            fi
          done

      - name: Attach SBOMs & Cosign bundles to the Release
        uses: step-security/action-gh-release@v2.4.1
        with:
          token: ${{ env.GITHUB_TOKEN }}
          files: |
            dist/*.spdx.json
            dist/*.cdx.json
            dist/*.cosign.bundle

      - name: Final dist listing (always)
        if: always()
        run: ls -al dist || true
